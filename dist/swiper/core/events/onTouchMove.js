import{getDocument}from"ssr-window";import $ from"../../shared/dom.js";import{now}from"../../shared/utils.js";export default function onTouchMove(t){const e=getDocument(),r=this,a=r.touchEventsData,{params:s,touches:n,rtlTranslate:o,enabled:l}=r;if(!l)return;let i=t;if(i.originalEvent&&(i=i.originalEvent),!a.isTouched)return void(a.startMoving&&a.isScrolling&&r.emit("touchMoveOpposite",i));if(a.isTouchEvent&&"touchmove"!==i.type)return;const c="touchmove"===i.type&&i.targetTouches&&(i.targetTouches[0]||i.changedTouches[0]),u="touchmove"===i.type?c.pageX:i.pageX,d="touchmove"===i.type?c.pageY:i.pageY;if(i.preventedByNestedSwiper)return n.startX=u,void(n.startY=d);if(!r.allowTouchMove)return r.allowClick=!1,void(a.isTouched&&(Object.assign(n,{startX:u,startY:d,currentX:u,currentY:d}),a.touchStartTime=now()));if(a.isTouchEvent&&s.touchReleaseOnEdges&&!s.loop)if(r.isVertical()){if(d<n.startY&&r.translate<=r.maxTranslate()||d>n.startY&&r.translate>=r.minTranslate())return a.isTouched=!1,void(a.isMoved=!1)}else if(u<n.startX&&r.translate<=r.maxTranslate()||u>n.startX&&r.translate>=r.minTranslate())return;if(a.isTouchEvent&&e.activeElement&&i.target===e.activeElement&&$(i.target).is(a.focusableElements))return a.isMoved=!0,void(r.allowClick=!1);if(a.allowTouchCallbacks&&r.emit("touchMove",i),i.targetTouches&&i.targetTouches.length>1)return;n.currentX=u,n.currentY=d;const T=n.currentX-n.startX,h=n.currentY-n.startY;if(r.params.threshold&&Math.sqrt(T**2+h**2)<r.params.threshold)return;if(void 0===a.isScrolling){let t;r.isHorizontal()&&n.currentY===n.startY||r.isVertical()&&n.currentX===n.startX?a.isScrolling=!1:T*T+h*h>=25&&(t=180*Math.atan2(Math.abs(h),Math.abs(T))/Math.PI,a.isScrolling=r.isHorizontal()?t>s.touchAngle:90-t>s.touchAngle)}if(a.isScrolling&&r.emit("touchMoveOpposite",i),void 0===a.startMoving&&(n.currentX===n.startX&&n.currentY===n.startY||(a.startMoving=!0)),a.isScrolling)return void(a.isTouched=!1);if(!a.startMoving)return;r.allowClick=!1,!s.cssMode&&i.cancelable&&i.preventDefault(),s.touchMoveStopPropagation&&!s.nested&&i.stopPropagation(),a.isMoved||(s.loop&&!s.cssMode&&r.loopFix(),a.startTranslate=r.getTranslate(),r.setTransition(0),r.animating&&r.$wrapperEl.trigger("webkitTransitionEnd transitionend"),a.allowMomentumBounce=!1,!s.grabCursor||!0!==r.allowSlideNext&&!0!==r.allowSlidePrev||r.setGrabCursor(!0),r.emit("sliderFirstMove",i)),r.emit("sliderMove",i),a.isMoved=!0;let v=r.isHorizontal()?T:h;n.diff=v,v*=s.touchRatio,o&&(v=-v),r.swipeDirection=v>0?"prev":"next",a.currentTranslate=v+a.startTranslate;let p=!0,g=s.resistanceRatio;if(s.touchReleaseOnEdges&&(g=0),v>0&&a.currentTranslate>r.minTranslate()?(p=!1,s.resistance&&(a.currentTranslate=r.minTranslate()-1+(-r.minTranslate()+a.startTranslate+v)**g)):v<0&&a.currentTranslate<r.maxTranslate()&&(p=!1,s.resistance&&(a.currentTranslate=r.maxTranslate()+1-(r.maxTranslate()-a.startTranslate-v)**g)),p&&(i.preventedByNestedSwiper=!0),!r.allowSlideNext&&"next"===r.swipeDirection&&a.currentTranslate<a.startTranslate&&(a.currentTranslate=a.startTranslate),!r.allowSlidePrev&&"prev"===r.swipeDirection&&a.currentTranslate>a.startTranslate&&(a.currentTranslate=a.startTranslate),r.allowSlidePrev||r.allowSlideNext||(a.currentTranslate=a.startTranslate),s.threshold>0){if(!(Math.abs(v)>s.threshold||a.allowThresholdMove))return void(a.currentTranslate=a.startTranslate);if(!a.allowThresholdMove)return a.allowThresholdMove=!0,n.startX=n.currentX,n.startY=n.currentY,a.currentTranslate=a.startTranslate,void(n.diff=r.isHorizontal()?n.currentX-n.startX:n.currentY-n.startY)}s.followFinger&&!s.cssMode&&((s.freeMode&&s.freeMode.enabled&&r.freeMode||s.watchSlidesProgress)&&(r.updateActiveIndex(),r.updateSlidesClasses()),r.params.freeMode&&s.freeMode.enabled&&r.freeMode&&r.freeMode.onTouchMove(),r.updateProgress(a.currentTranslate),r.setTranslate(a.currentTranslate))}