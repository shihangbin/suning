import{now}from"../../shared/utils.js";export default function freeMode({swiper:e,extendParams:t,emit:o,once:i}){t({freeMode:{enabled:!1,momentum:!0,momentumRatio:1,momentumBounce:!0,momentumBounceRatio:1,momentumVelocityRatio:1,sticky:!1,minimumVelocity:.02}}),Object.assign(e,{freeMode:{onTouchMove:function(){const{touchEventsData:t,touches:o}=e;0===t.velocities.length&&t.velocities.push({position:o[e.isHorizontal()?"startX":"startY"],time:t.touchStartTime}),t.velocities.push({position:o[e.isHorizontal()?"currentX":"currentY"],time:now()})},onTouchEnd:function({currentPos:t}){const{params:n,$wrapperEl:s,rtlTranslate:a,snapGrid:l,touchEventsData:r}=e,m=now()-r.touchStartTime;if(t<-e.minTranslate())e.slideTo(e.activeIndex);else if(t>-e.maxTranslate())e.slides.length<l.length?e.slideTo(l.length-1):e.slideTo(e.slides.length-1);else{if(n.freeMode.momentum){if(r.velocities.length>1){const t=r.velocities.pop(),o=r.velocities.pop(),i=t.position-o.position,s=t.time-o.time;e.velocity=i/s,e.velocity/=2,Math.abs(e.velocity)<n.freeMode.minimumVelocity&&(e.velocity=0),(s>150||now()-t.time>300)&&(e.velocity=0)}else e.velocity=0;e.velocity*=n.freeMode.momentumVelocityRatio,r.velocities.length=0;let t=1e3*n.freeMode.momentumRatio;const m=e.velocity*t;let d=e.translate+m;a&&(d=-d);let c,u=!1;const f=20*Math.abs(e.velocity)*n.freeMode.momentumBounceRatio;let p;if(d<e.maxTranslate())n.freeMode.momentumBounce?(d+e.maxTranslate()<-f&&(d=e.maxTranslate()-f),c=e.maxTranslate(),u=!0,r.allowMomentumBounce=!0):d=e.maxTranslate(),n.loop&&n.centeredSlides&&(p=!0);else if(d>e.minTranslate())n.freeMode.momentumBounce?(d-e.minTranslate()>f&&(d=e.minTranslate()+f),c=e.minTranslate(),u=!0,r.allowMomentumBounce=!0):d=e.minTranslate(),n.loop&&n.centeredSlides&&(p=!0);else if(n.freeMode.sticky){let t;for(let e=0;e<l.length;e+=1)if(l[e]>-d){t=e;break}d=Math.abs(l[t]-d)<Math.abs(l[t-1]-d)||"next"===e.swipeDirection?l[t]:l[t-1],d=-d}if(p&&i("transitionEnd",(()=>{e.loopFix()})),0!==e.velocity){if(t=a?Math.abs((-d-e.translate)/e.velocity):Math.abs((d-e.translate)/e.velocity),n.freeMode.sticky){const o=Math.abs((a?-d:d)-e.translate),i=e.slidesSizesGrid[e.activeIndex];t=o<i?n.speed:o<2*i?1.5*n.speed:2.5*n.speed}}else if(n.freeMode.sticky)return void e.slideToClosest();n.freeMode.momentumBounce&&u?(e.updateProgress(c),e.setTransition(t),e.setTranslate(d),e.transitionStart(!0,e.swipeDirection),e.animating=!0,s.transitionEnd((()=>{e&&!e.destroyed&&r.allowMomentumBounce&&(o("momentumBounce"),e.setTransition(n.speed),setTimeout((()=>{e.setTranslate(c),s.transitionEnd((()=>{e&&!e.destroyed&&e.transitionEnd()}))}),0))}))):e.velocity?(o("_freeModeNoMomentumRelease"),e.updateProgress(d),e.setTransition(t),e.setTranslate(d),e.transitionStart(!0,e.swipeDirection),e.animating||(e.animating=!0,s.transitionEnd((()=>{e&&!e.destroyed&&e.transitionEnd()})))):e.updateProgress(d),e.updateActiveIndex(),e.updateSlidesClasses()}else{if(n.freeMode.sticky)return void e.slideToClosest();n.freeMode&&o("_freeModeNoMomentumRelease")}(!n.freeMode.momentum||m>=n.longSwipesMs)&&(e.updateProgress(),e.updateActiveIndex(),e.updateSlidesClasses())}}}})}