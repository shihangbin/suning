import{getWindow}from"ssr-window";import $ from"../../shared/dom.js";import{getTranslate}from"../../shared/utils.js";export default function Zoom({swiper:e,extendParams:t,on:a,emit:s}){const r=getWindow();t({zoom:{enabled:!1,maxRatio:3,minRatio:1,toggle:!0,containerClass:"swiper-zoom-container",zoomedSlideClass:"swiper-slide-zoomed"}}),e.zoom={enabled:!1};let o,i,n,l=1,c=!1;const m={$slideEl:void 0,slideWidth:void 0,slideHeight:void 0,$imageEl:void 0,$imageWrapEl:void 0,maxRatio:3},u={isTouched:void 0,isMoved:void 0,currentX:void 0,currentY:void 0,minX:void 0,minY:void 0,maxX:void 0,maxY:void 0,width:void 0,height:void 0,startX:void 0,startY:void 0,touchesStart:{},touchesCurrent:{}},d={x:void 0,y:void 0,prevPositionX:void 0,prevPositionY:void 0,prevTime:void 0};let p=1;function h(e){if(e.targetTouches.length<2)return 1;const t=e.targetTouches[0].pageX,a=e.targetTouches[0].pageY,s=e.targetTouches[1].pageX,r=e.targetTouches[1].pageY;return Math.sqrt((s-t)**2+(r-a)**2)}function g(t){const a=e.support,s=e.params.zoom;if(i=!1,n=!1,!a.gestures){if("touchstart"!==t.type||"touchstart"===t.type&&t.targetTouches.length<2)return;i=!0,m.scaleStart=h(t)}m.$slideEl&&m.$slideEl.length||(m.$slideEl=$(t.target).closest(`.${e.params.slideClass}`),0===m.$slideEl.length&&(m.$slideEl=e.slides.eq(e.activeIndex)),m.$imageEl=m.$slideEl.find(`.${s.containerClass}`).eq(0).find("picture, img, svg, canvas, .swiper-zoom-target").eq(0),m.$imageWrapEl=m.$imageEl.parent(`.${s.containerClass}`),m.maxRatio=m.$imageWrapEl.attr("data-swiper-zoom")||s.maxRatio,0!==m.$imageWrapEl.length)?(m.$imageEl&&m.$imageEl.transition(0),c=!0):m.$imageEl=void 0}function E(t){const a=e.support,s=e.params.zoom,r=e.zoom;if(!a.gestures){if("touchmove"!==t.type||"touchmove"===t.type&&t.targetTouches.length<2)return;n=!0,m.scaleMove=h(t)}m.$imageEl&&0!==m.$imageEl.length?(a.gestures?r.scale=t.scale*l:r.scale=m.scaleMove/m.scaleStart*l,r.scale>m.maxRatio&&(r.scale=m.maxRatio-1+(r.scale-m.maxRatio+1)**.5),r.scale<s.minRatio&&(r.scale=s.minRatio+1-(s.minRatio-r.scale+1)**.5),m.$imageEl.transform(`translate3d(0,0,0) scale(${r.scale})`)):"gesturechange"===t.type&&g(t)}function v(t){const a=e.device,s=e.support,r=e.params.zoom,o=e.zoom;if(!s.gestures){if(!i||!n)return;if("touchend"!==t.type||"touchend"===t.type&&t.changedTouches.length<2&&!a.android)return;i=!1,n=!1}m.$imageEl&&0!==m.$imageEl.length&&(o.scale=Math.max(Math.min(o.scale,m.maxRatio),r.minRatio),m.$imageEl.transition(e.params.speed).transform(`translate3d(0,0,0) scale(${o.scale})`),l=o.scale,c=!1,1===o.scale&&(m.$slideEl=void 0))}function f(t){const a=e.zoom;if(!m.$imageEl||0===m.$imageEl.length)return;if(e.allowClick=!1,!u.isTouched||!m.$slideEl)return;u.isMoved||(u.width=m.$imageEl[0].offsetWidth,u.height=m.$imageEl[0].offsetHeight,u.startX=getTranslate(m.$imageWrapEl[0],"x")||0,u.startY=getTranslate(m.$imageWrapEl[0],"y")||0,m.slideWidth=m.$slideEl[0].offsetWidth,m.slideHeight=m.$slideEl[0].offsetHeight,m.$imageWrapEl.transition(0));const s=u.width*a.scale,r=u.height*a.scale;if(!(s<m.slideWidth&&r<m.slideHeight)){if(u.minX=Math.min(m.slideWidth/2-s/2,0),u.maxX=-u.minX,u.minY=Math.min(m.slideHeight/2-r/2,0),u.maxY=-u.minY,u.touchesCurrent.x="touchmove"===t.type?t.targetTouches[0].pageX:t.pageX,u.touchesCurrent.y="touchmove"===t.type?t.targetTouches[0].pageY:t.pageY,!u.isMoved&&!c){if(e.isHorizontal()&&(Math.floor(u.minX)===Math.floor(u.startX)&&u.touchesCurrent.x<u.touchesStart.x||Math.floor(u.maxX)===Math.floor(u.startX)&&u.touchesCurrent.x>u.touchesStart.x))return void(u.isTouched=!1);if(!e.isHorizontal()&&(Math.floor(u.minY)===Math.floor(u.startY)&&u.touchesCurrent.y<u.touchesStart.y||Math.floor(u.maxY)===Math.floor(u.startY)&&u.touchesCurrent.y>u.touchesStart.y))return void(u.isTouched=!1)}t.cancelable&&t.preventDefault(),t.stopPropagation(),u.isMoved=!0,u.currentX=u.touchesCurrent.x-u.touchesStart.x+u.startX,u.currentY=u.touchesCurrent.y-u.touchesStart.y+u.startY,u.currentX<u.minX&&(u.currentX=u.minX+1-(u.minX-u.currentX+1)**.8),u.currentX>u.maxX&&(u.currentX=u.maxX-1+(u.currentX-u.maxX+1)**.8),u.currentY<u.minY&&(u.currentY=u.minY+1-(u.minY-u.currentY+1)**.8),u.currentY>u.maxY&&(u.currentY=u.maxY-1+(u.currentY-u.maxY+1)**.8),d.prevPositionX||(d.prevPositionX=u.touchesCurrent.x),d.prevPositionY||(d.prevPositionY=u.touchesCurrent.y),d.prevTime||(d.prevTime=Date.now()),d.x=(u.touchesCurrent.x-d.prevPositionX)/(Date.now()-d.prevTime)/2,d.y=(u.touchesCurrent.y-d.prevPositionY)/(Date.now()-d.prevTime)/2,Math.abs(u.touchesCurrent.x-d.prevPositionX)<2&&(d.x=0),Math.abs(u.touchesCurrent.y-d.prevPositionY)<2&&(d.y=0),d.prevPositionX=u.touchesCurrent.x,d.prevPositionY=u.touchesCurrent.y,d.prevTime=Date.now(),m.$imageWrapEl.transform(`translate3d(${u.currentX}px, ${u.currentY}px,0)`)}}function x(){const t=e.zoom;m.$slideEl&&e.previousIndex!==e.activeIndex&&(m.$imageEl&&m.$imageEl.transform("translate3d(0,0,0) scale(1)"),m.$imageWrapEl&&m.$imageWrapEl.transform("translate3d(0,0,0)"),t.scale=1,l=1,m.$slideEl=void 0,m.$imageEl=void 0,m.$imageWrapEl=void 0)}function X(t){const a=e.zoom,s=e.params.zoom;if(m.$slideEl||(t&&t.target&&(m.$slideEl=$(t.target).closest(`.${e.params.slideClass}`)),m.$slideEl||(e.params.virtual&&e.params.virtual.enabled&&e.virtual?m.$slideEl=e.$wrapperEl.children(`.${e.params.slideActiveClass}`):m.$slideEl=e.slides.eq(e.activeIndex)),m.$imageEl=m.$slideEl.find(`.${s.containerClass}`).eq(0).find("picture, img, svg, canvas, .swiper-zoom-target").eq(0),m.$imageWrapEl=m.$imageEl.parent(`.${s.containerClass}`)),!m.$imageEl||0===m.$imageEl.length||!m.$imageWrapEl||0===m.$imageWrapEl.length)return;let o,i,n,c,d,p,h,g,E,v,f,x,X,Y,w,z,C,y;e.params.cssMode&&(e.wrapperEl.style.overflow="hidden",e.wrapperEl.style.touchAction="none"),m.$slideEl.addClass(`${s.zoomedSlideClass}`),void 0===u.touchesStart.x&&t?(o="touchend"===t.type?t.changedTouches[0].pageX:t.pageX,i="touchend"===t.type?t.changedTouches[0].pageY:t.pageY):(o=u.touchesStart.x,i=u.touchesStart.y),a.scale=m.$imageWrapEl.attr("data-swiper-zoom")||s.maxRatio,l=m.$imageWrapEl.attr("data-swiper-zoom")||s.maxRatio,t?(C=m.$slideEl[0].offsetWidth,y=m.$slideEl[0].offsetHeight,n=m.$slideEl.offset().left+r.scrollX,c=m.$slideEl.offset().top+r.scrollY,d=n+C/2-o,p=c+y/2-i,E=m.$imageEl[0].offsetWidth,v=m.$imageEl[0].offsetHeight,f=E*a.scale,x=v*a.scale,X=Math.min(C/2-f/2,0),Y=Math.min(y/2-x/2,0),w=-X,z=-Y,h=d*a.scale,g=p*a.scale,h<X&&(h=X),h>w&&(h=w),g<Y&&(g=Y),g>z&&(g=z)):(h=0,g=0),m.$imageWrapEl.transition(300).transform(`translate3d(${h}px, ${g}px,0)`),m.$imageEl.transition(300).transform(`translate3d(0,0,0) scale(${a.scale})`)}function Y(){const t=e.zoom,a=e.params.zoom;m.$slideEl||(e.params.virtual&&e.params.virtual.enabled&&e.virtual?m.$slideEl=e.$wrapperEl.children(`.${e.params.slideActiveClass}`):m.$slideEl=e.slides.eq(e.activeIndex),m.$imageEl=m.$slideEl.find(`.${a.containerClass}`).eq(0).find("picture, img, svg, canvas, .swiper-zoom-target").eq(0),m.$imageWrapEl=m.$imageEl.parent(`.${a.containerClass}`)),m.$imageEl&&0!==m.$imageEl.length&&m.$imageWrapEl&&0!==m.$imageWrapEl.length&&(e.params.cssMode&&(e.wrapperEl.style.overflow="",e.wrapperEl.style.touchAction=""),t.scale=1,l=1,m.$imageWrapEl.transition(300).transform("translate3d(0,0,0)"),m.$imageEl.transition(300).transform("translate3d(0,0,0) scale(1)"),m.$slideEl.removeClass(`${a.zoomedSlideClass}`),m.$slideEl=void 0)}function w(t){const a=e.zoom;a.scale&&1!==a.scale?Y():X(t)}function z(){const t=e.support;return{passiveListener:!("touchstart"!==e.touchEvents.start||!t.passiveListener||!e.params.passiveListeners)&&{passive:!0,capture:!1},activeListenerWithCapture:!t.passiveListener||{passive:!1,capture:!0}}}function C(){return`.${e.params.slideClass}`}function y(t){const{passiveListener:a}=z(),s=C();e.$wrapperEl[t]("gesturestart",s,g,a),e.$wrapperEl[t]("gesturechange",s,E,a),e.$wrapperEl[t]("gestureend",s,v,a)}function M(){o||(o=!0,y("on"))}function W(){o&&(o=!1,y("off"))}function T(){const t=e.zoom;if(t.enabled)return;t.enabled=!0;const a=e.support,{passiveListener:s,activeListenerWithCapture:r}=z(),o=C();a.gestures?(e.$wrapperEl.on(e.touchEvents.start,M,s),e.$wrapperEl.on(e.touchEvents.end,W,s)):"touchstart"===e.touchEvents.start&&(e.$wrapperEl.on(e.touchEvents.start,o,g,s),e.$wrapperEl.on(e.touchEvents.move,o,E,r),e.$wrapperEl.on(e.touchEvents.end,o,v,s),e.touchEvents.cancel&&e.$wrapperEl.on(e.touchEvents.cancel,o,v,s)),e.$wrapperEl.on(e.touchEvents.move,`.${e.params.zoom.containerClass}`,f,r)}function b(){const t=e.zoom;if(!t.enabled)return;const a=e.support;t.enabled=!1;const{passiveListener:s,activeListenerWithCapture:r}=z(),o=C();a.gestures?(e.$wrapperEl.off(e.touchEvents.start,M,s),e.$wrapperEl.off(e.touchEvents.end,W,s)):"touchstart"===e.touchEvents.start&&(e.$wrapperEl.off(e.touchEvents.start,o,g,s),e.$wrapperEl.off(e.touchEvents.move,o,E,r),e.$wrapperEl.off(e.touchEvents.end,o,v,s),e.touchEvents.cancel&&e.$wrapperEl.off(e.touchEvents.cancel,o,v,s)),e.$wrapperEl.off(e.touchEvents.move,`.${e.params.zoom.containerClass}`,f,r)}Object.defineProperty(e.zoom,"scale",{get(){return p},set(e){if(p!==e){const t=m.$imageEl?m.$imageEl[0]:void 0,a=m.$slideEl?m.$slideEl[0]:void 0;s("zoomChange",e,t,a)}p=e}}),a("init",(()=>{e.params.zoom.enabled&&T()})),a("destroy",(()=>{b()})),a("touchStart",((t,a)=>{e.zoom.enabled&&function(t){const a=e.device;m.$imageEl&&0!==m.$imageEl.length&&(u.isTouched||(a.android&&t.cancelable&&t.preventDefault(),u.isTouched=!0,u.touchesStart.x="touchstart"===t.type?t.targetTouches[0].pageX:t.pageX,u.touchesStart.y="touchstart"===t.type?t.targetTouches[0].pageY:t.pageY))}(a)})),a("touchEnd",((t,a)=>{e.zoom.enabled&&function(){const t=e.zoom;if(!m.$imageEl||0===m.$imageEl.length)return;if(!u.isTouched||!u.isMoved)return u.isTouched=!1,void(u.isMoved=!1);u.isTouched=!1,u.isMoved=!1;let a=300,s=300;const r=d.x*a,o=u.currentX+r,i=d.y*s,n=u.currentY+i;0!==d.x&&(a=Math.abs((o-u.currentX)/d.x)),0!==d.y&&(s=Math.abs((n-u.currentY)/d.y));const l=Math.max(a,s);u.currentX=o,u.currentY=n;const c=u.width*t.scale,p=u.height*t.scale;u.minX=Math.min(m.slideWidth/2-c/2,0),u.maxX=-u.minX,u.minY=Math.min(m.slideHeight/2-p/2,0),u.maxY=-u.minY,u.currentX=Math.max(Math.min(u.currentX,u.maxX),u.minX),u.currentY=Math.max(Math.min(u.currentY,u.maxY),u.minY),m.$imageWrapEl.transition(l).transform(`translate3d(${u.currentX}px, ${u.currentY}px,0)`)}()})),a("doubleTap",((t,a)=>{!e.animating&&e.params.zoom.enabled&&e.zoom.enabled&&e.params.zoom.toggle&&w(a)})),a("transitionEnd",(()=>{e.zoom.enabled&&e.params.zoom.enabled&&x()})),a("slideChange",(()=>{e.zoom.enabled&&e.params.zoom.enabled&&e.params.cssMode&&x()})),Object.assign(e.zoom,{enable:T,disable:b,in:X,out:Y,toggle:w})}