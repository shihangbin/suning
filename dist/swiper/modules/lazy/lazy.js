import{getWindow}from"ssr-window";import $ from"../../shared/dom.js";export default function Lazy({swiper:a,extendParams:e,on:s,emit:t}){e({lazy:{checkInView:!1,enabled:!1,loadPrevNext:!1,loadPrevNextAmount:1,loadOnTransitionStart:!1,scrollingElement:"",elementClass:"swiper-lazy",loadingClass:"swiper-lazy-loading",loadedClass:"swiper-lazy-loaded",preloaderClass:"swiper-lazy-preloader"}}),a.lazy={};let l=!1,r=!1;function i(e,s=!0){const l=a.params.lazy;if(void 0===e)return;if(0===a.slides.length)return;const r=a.virtual&&a.params.virtual.enabled?a.$wrapperEl.children(`.${a.params.slideClass}[data-swiper-slide-index="${e}"]`):a.slides.eq(e),n=r.find(`.${l.elementClass}:not(.${l.loadedClass}):not(.${l.loadingClass})`);!r.hasClass(l.elementClass)||r.hasClass(l.loadedClass)||r.hasClass(l.loadingClass)||n.push(r[0]),0!==n.length&&n.each((e=>{const n=$(e);n.addClass(l.loadingClass);const d=n.attr("data-background"),o=n.attr("data-src"),c=n.attr("data-srcset"),p=n.attr("data-sizes"),m=n.parent("picture");a.loadImage(n[0],o||d,c,p,!1,(()=>{if(null!=a&&a&&(!a||a.params)&&!a.destroyed){if(d?(n.css("background-image",`url("${d}")`),n.removeAttr("data-background")):(c&&(n.attr("srcset",c),n.removeAttr("data-srcset")),p&&(n.attr("sizes",p),n.removeAttr("data-sizes")),m.length&&m.children("source").each((a=>{const e=$(a);e.attr("data-srcset")&&(e.attr("srcset",e.attr("data-srcset")),e.removeAttr("data-srcset"))})),o&&(n.attr("src",o),n.removeAttr("data-src"))),n.addClass(l.loadedClass).removeClass(l.loadingClass),r.find(`.${l.preloaderClass}`).remove(),a.params.loop&&s){const e=r.attr("data-swiper-slide-index");if(r.hasClass(a.params.slideDuplicateClass)){i(a.$wrapperEl.children(`[data-swiper-slide-index="${e}"]:not(.${a.params.slideDuplicateClass})`).index(),!1)}else{i(a.$wrapperEl.children(`.${a.params.slideDuplicateClass}[data-swiper-slide-index="${e}"]`).index(),!1)}}t("lazyImageReady",r[0],n[0]),a.params.autoHeight&&a.updateAutoHeight()}})),t("lazyImageLoad",r[0],n[0])}))}function n(){const{$wrapperEl:e,params:s,slides:t,activeIndex:l}=a,n=a.virtual&&s.virtual.enabled,d=s.lazy;let o=s.slidesPerView;function c(a){if(n){if(e.children(`.${s.slideClass}[data-swiper-slide-index="${a}"]`).length)return!0}else if(t[a])return!0;return!1}function p(a){return n?$(a).attr("data-swiper-slide-index"):$(a).index()}if("auto"===o&&(o=0),r||(r=!0),a.params.watchSlidesProgress)e.children(`.${s.slideVisibleClass}`).each((a=>{i(n?$(a).attr("data-swiper-slide-index"):$(a).index())}));else if(o>1)for(let a=l;a<l+o;a+=1)c(a)&&i(a);else i(l);if(d.loadPrevNext)if(o>1||d.loadPrevNextAmount&&d.loadPrevNextAmount>1){const a=d.loadPrevNextAmount,e=o,s=Math.min(l+e+Math.max(a,e),t.length),r=Math.max(l-Math.max(e,a),0);for(let a=l+o;a<s;a+=1)c(a)&&i(a);for(let a=r;a<l;a+=1)c(a)&&i(a)}else{const a=e.children(`.${s.slideNextClass}`);a.length>0&&i(p(a));const t=e.children(`.${s.slidePrevClass}`);t.length>0&&i(p(t))}}function d(){const e=getWindow();if(!a||a.destroyed)return;const s=a.params.lazy.scrollingElement?$(a.params.lazy.scrollingElement):$(e),t=s[0]===e,r=t?e.innerWidth:s[0].offsetWidth,i=t?e.innerHeight:s[0].offsetHeight,o=a.$el.offset(),{rtlTranslate:c}=a;let p=!1;c&&(o.left-=a.$el[0].scrollLeft);const m=[[o.left,o.top],[o.left+a.width,o.top],[o.left,o.top+a.height],[o.left+a.width,o.top+a.height]];for(let a=0;a<m.length;a+=1){const e=m[a];if(e[0]>=0&&e[0]<=r&&e[1]>=0&&e[1]<=i){if(0===e[0]&&0===e[1])continue;p=!0}}const h=!("touchstart"!==a.touchEvents.start||!a.support.passiveListener||!a.params.passiveListeners)&&{passive:!0,capture:!1};p?(n(),s.off("scroll",d,h)):l||(l=!0,s.on("scroll",d,h))}s("beforeInit",(()=>{a.params.lazy.enabled&&a.params.preloadImages&&(a.params.preloadImages=!1)})),s("init",(()=>{a.params.lazy.enabled&&(a.params.lazy.checkInView?d():n())})),s("scroll",(()=>{a.params.freeMode&&a.params.freeMode.enabled&&!a.params.freeMode.sticky&&n()})),s("scrollbarDragMove resize _freeModeNoMomentumRelease",(()=>{a.params.lazy.enabled&&(a.params.lazy.checkInView?d():n())})),s("transitionStart",(()=>{a.params.lazy.enabled&&(a.params.lazy.loadOnTransitionStart||!a.params.lazy.loadOnTransitionStart&&!r)&&(a.params.lazy.checkInView?d():n())})),s("transitionEnd",(()=>{a.params.lazy.enabled&&!a.params.lazy.loadOnTransitionStart&&(a.params.lazy.checkInView?d():n())})),s("slideChange",(()=>{const{lazy:e,cssMode:s,watchSlidesProgress:t,touchReleaseOnEdges:l,resistanceRatio:r}=a.params;e.enabled&&(s||t&&(l||0===r))&&n()})),Object.assign(a.lazy,{load:n,loadInSlide:i})}