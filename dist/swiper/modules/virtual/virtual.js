import $ from"../../shared/dom.js";import{setCSSProperty}from"../../shared/utils.js";export default function Virtual({swiper:e,extendParams:a,on:r}){let s;function i(a,r){const s=e.params.virtual;if(s.cache&&e.virtual.cache[r])return e.virtual.cache[r];const i=s.renderSlide?$(s.renderSlide.call(e,a,r)):$(`<div class="${e.params.slideClass}" data-swiper-slide-index="${r}">${a}</div>`);return i.attr("data-swiper-slide-index")||i.attr("data-swiper-slide-index",r),s.cache&&(e.virtual.cache[r]=i),i}function t(a){const{slidesPerView:r,slidesPerGroup:s,centeredSlides:t}=e.params,{addSlidesBefore:l,addSlidesAfter:d}=e.params.virtual,{from:n,to:o,slides:p,slidesGrid:c,offset:u}=e.virtual;e.params.cssMode||e.updateActiveIndex();const f=e.activeIndex||0;let v,h,m;v=e.rtlTranslate?"right":e.isHorizontal()?"left":"top",t?(h=Math.floor(r/2)+s+d,m=Math.floor(r/2)+s+l):(h=r+(s-1)+d,m=s+l);const x=Math.max((f||0)-m,0),S=Math.min((f||0)+h,p.length-1),w=(e.slidesGrid[x]||0)-(e.slidesGrid[0]||0);function $(){e.updateSlides(),e.updateProgress(),e.updateSlidesClasses(),e.lazy&&e.params.lazy.enabled&&e.lazy.load()}if(Object.assign(e.virtual,{from:x,to:S,offset:w,slidesGrid:e.slidesGrid}),n===x&&o===S&&!a)return e.slidesGrid!==c&&w!==u&&e.slides.css(v,`${w}px`),void e.updateProgress();if(e.params.virtual.renderExternal)return e.params.virtual.renderExternal.call(e,{offset:w,from:x,to:S,slides:function(){const e=[];for(let a=x;a<=S;a+=1)e.push(p[a]);return e}()}),void(e.params.virtual.renderExternalUpdate&&$());const g=[],E=[];if(a)e.$wrapperEl.find(`.${e.params.slideClass}`).remove();else for(let a=n;a<=o;a+=1)(a<x||a>S)&&e.$wrapperEl.find(`.${e.params.slideClass}[data-swiper-slide-index="${a}"]`).remove();for(let e=0;e<p.length;e+=1)e>=x&&e<=S&&(void 0===o||a?E.push(e):(e>o&&E.push(e),e<n&&g.push(e)));E.forEach((a=>{e.$wrapperEl.append(i(p[a],a))})),g.sort(((e,a)=>a-e)).forEach((a=>{e.$wrapperEl.prepend(i(p[a],a))})),e.$wrapperEl.children(".swiper-slide").css(v,`${w}px`),$()}a({virtual:{enabled:!1,slides:[],cache:!0,renderSlide:null,renderExternal:null,renderExternalUpdate:!0,addSlidesBefore:0,addSlidesAfter:0}}),e.virtual={cache:{},from:void 0,to:void 0,slides:[],offset:0,slidesGrid:[]},r("beforeInit",(()=>{e.params.virtual.enabled&&(e.virtual.slides=e.params.virtual.slides,e.classNames.push(`${e.params.containerModifierClass}virtual`),e.params.watchSlidesProgress=!0,e.originalParams.watchSlidesProgress=!0,e.params.initialSlide||t())})),r("setTranslate",(()=>{e.params.virtual.enabled&&(e.params.cssMode&&!e._immediateVirtual?(clearTimeout(s),s=setTimeout((()=>{t()}),100)):t())})),r("init update resize",(()=>{e.params.virtual.enabled&&e.params.cssMode&&setCSSProperty(e.wrapperEl,"--swiper-virtual-size",`${e.virtualSize}px`)})),Object.assign(e.virtual,{appendSlide:function(a){if("object"==typeof a&&"length"in a)for(let r=0;r<a.length;r+=1)a[r]&&e.virtual.slides.push(a[r]);else e.virtual.slides.push(a);t(!0)},prependSlide:function(a){const r=e.activeIndex;let s=r+1,i=1;if(Array.isArray(a)){for(let r=0;r<a.length;r+=1)a[r]&&e.virtual.slides.unshift(a[r]);s=r+a.length,i=a.length}else e.virtual.slides.unshift(a);if(e.params.virtual.cache){const a=e.virtual.cache,r={};Object.keys(a).forEach((e=>{const s=a[e],t=s.attr("data-swiper-slide-index");t&&s.attr("data-swiper-slide-index",parseInt(t,10)+i),r[parseInt(e,10)+i]=s})),e.virtual.cache=r}t(!0),e.slideTo(s,0)},removeSlide:function(a){if(null==a)return;let r=e.activeIndex;if(Array.isArray(a))for(let s=a.length-1;s>=0;s-=1)e.virtual.slides.splice(a[s],1),e.params.virtual.cache&&delete e.virtual.cache[a[s]],a[s]<r&&(r-=1),r=Math.max(r,0);else e.virtual.slides.splice(a,1),e.params.virtual.cache&&delete e.virtual.cache[a],a<r&&(r-=1),r=Math.max(r,0);t(!0),e.slideTo(r,0)},removeAllSlides:function(){e.virtual.slides=[],e.params.virtual.cache&&(e.virtual.cache={}),t(!0),e.slideTo(0,0)},update:t})}