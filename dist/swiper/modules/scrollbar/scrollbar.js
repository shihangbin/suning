import{getDocument}from"ssr-window";import $ from"../../shared/dom.js";import{nextTick}from"../../shared/utils.js";import createElementIfNotDefined from"../../shared/create-element-if-not-defined.js";export default function Scrollbar({swiper:e,extendParams:r,on:a,emit:s}){const l=getDocument();let t,o,n,i,c=!1,p=null,d=null;function u(){if(!e.params.scrollbar.el||!e.scrollbar.el)return;const{scrollbar:r,rtlTranslate:a,progress:s}=e,{$dragEl:l,$el:t}=r,i=e.params.scrollbar;let c=o,d=(n-o)*s;a?(d=-d,d>0?(c=o-d,d=0):-d+o>n&&(c=n+d)):d<0?(c=o+d,d=0):d+o>n&&(c=n-d),e.isHorizontal()?(l.transform(`translate3d(${d}px, 0, 0)`),l[0].style.width=`${c}px`):(l.transform(`translate3d(0px, ${d}px, 0)`),l[0].style.height=`${c}px`),i.hide&&(clearTimeout(p),t[0].style.opacity=1,p=setTimeout((()=>{t[0].style.opacity=0,t.transition(400)}),1e3))}function m(){if(!e.params.scrollbar.el||!e.scrollbar.el)return;const{scrollbar:r}=e,{$dragEl:a,$el:s}=r;a[0].style.width="",a[0].style.height="",n=e.isHorizontal()?s[0].offsetWidth:s[0].offsetHeight,i=e.size/(e.virtualSize+e.params.slidesOffsetBefore-(e.params.centeredSlides?e.snapGrid[0]:0)),o="auto"===e.params.scrollbar.dragSize?n*i:parseInt(e.params.scrollbar.dragSize,10),e.isHorizontal()?a[0].style.width=`${o}px`:a[0].style.height=`${o}px`,s[0].style.display=i>=1?"none":"",e.params.scrollbar.hide&&(s[0].style.opacity=0),e.params.watchOverflow&&e.enabled&&r.$el[e.isLocked?"addClass":"removeClass"](e.params.scrollbar.lockClass)}function b(r){return e.isHorizontal()?"touchstart"===r.type||"touchmove"===r.type?r.targetTouches[0].clientX:r.clientX:"touchstart"===r.type||"touchmove"===r.type?r.targetTouches[0].clientY:r.clientY}function f(r){const{scrollbar:a,rtlTranslate:s}=e,{$el:l}=a;let i;i=(b(r)-l.offset()[e.isHorizontal()?"left":"top"]-(null!==t?t:o/2))/(n-o),i=Math.max(Math.min(i,1),0),s&&(i=1-i);const c=e.minTranslate()+(e.maxTranslate()-e.minTranslate())*i;e.updateProgress(c),e.setTranslate(c),e.updateActiveIndex(),e.updateSlidesClasses()}function g(r){const a=e.params.scrollbar,{scrollbar:l,$wrapperEl:o}=e,{$el:n,$dragEl:i}=l;c=!0,t=r.target===i[0]||r.target===i?b(r)-r.target.getBoundingClientRect()[e.isHorizontal()?"left":"top"]:null,r.preventDefault(),r.stopPropagation(),o.transition(100),i.transition(100),f(r),clearTimeout(d),n.transition(0),a.hide&&n.css("opacity",1),e.params.cssMode&&e.$wrapperEl.css("scroll-snap-type","none"),s("scrollbarDragStart",r)}function h(r){const{scrollbar:a,$wrapperEl:l}=e,{$el:t,$dragEl:o}=a;c&&(r.preventDefault?r.preventDefault():r.returnValue=!1,f(r),l.transition(0),t.transition(0),o.transition(0),s("scrollbarDragMove",r))}function v(r){const a=e.params.scrollbar,{scrollbar:l,$wrapperEl:t}=e,{$el:o}=l;c&&(c=!1,e.params.cssMode&&(e.$wrapperEl.css("scroll-snap-type",""),t.transition("")),a.hide&&(clearTimeout(d),d=nextTick((()=>{o.css("opacity",0),o.transition(400)}),1e3)),s("scrollbarDragEnd",r),a.snapOnRelease&&e.slideToClosest())}function y(r){const{scrollbar:a,touchEventsTouch:s,touchEventsDesktop:t,params:o,support:n}=e,i=a.$el[0],c=!(!n.passiveListener||!o.passiveListeners)&&{passive:!1,capture:!1},p=!(!n.passiveListener||!o.passiveListeners)&&{passive:!0,capture:!1};if(!i)return;const d="on"===r?"addEventListener":"removeEventListener";n.touch?(i[d](s.start,g,c),i[d](s.move,h,c),i[d](s.end,v,p)):(i[d](t.start,g,c),l[d](t.move,h,c),l[d](t.end,v,p))}function E(){const{scrollbar:r,$el:a}=e;e.params.scrollbar=createElementIfNotDefined(e,e.originalParams.scrollbar,e.params.scrollbar,{el:"swiper-scrollbar"});const s=e.params.scrollbar;if(!s.el)return;let l=$(s.el);e.params.uniqueNavElements&&"string"==typeof s.el&&l.length>1&&1===a.find(s.el).length&&(l=a.find(s.el));let t=l.find(`.${e.params.scrollbar.dragClass}`);0===t.length&&(t=$(`<div class="${e.params.scrollbar.dragClass}"></div>`),l.append(t)),Object.assign(r,{$el:l,el:l[0],$dragEl:t,dragEl:t[0]}),s.draggable&&e.params.scrollbar.el&&y("on"),l&&l[e.enabled?"removeClass":"addClass"](e.params.scrollbar.lockClass)}function T(){e.params.scrollbar.el&&y("off")}r({scrollbar:{el:null,dragSize:"auto",hide:!1,draggable:!1,snapOnRelease:!0,lockClass:"swiper-scrollbar-lock",dragClass:"swiper-scrollbar-drag"}}),e.scrollbar={el:null,dragEl:null,$el:null,$dragEl:null},a("init",(()=>{E(),m(),u()})),a("update resize observerUpdate lock unlock",(()=>{m()})),a("setTranslate",(()=>{u()})),a("setTransition",((r,a)=>{!function(r){e.params.scrollbar.el&&e.scrollbar.el&&e.scrollbar.$dragEl.transition(r)}(a)})),a("enable disable",(()=>{const{$el:r}=e.scrollbar;r&&r[e.enabled?"removeClass":"addClass"](e.params.scrollbar.lockClass)})),a("destroy",(()=>{T()})),Object.assign(e.scrollbar,{updateSize:m,setTranslate:u,init:E,destroy:T})}